<html>

<head>
    <title>JavaScript MQTT WebSocket Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript">
    </script>
    <script type="text/javascript" language="javascript">
        var mqtt;
        var reconnectTimeout = 5000;
        var host = "broker.hivemq.com"; //change this
        var port = 8000;
        var lastsendmsg;

        function onFailure(message) {
            console.log("Connection Attempt to Host " + host + "Failed");
            document.getElementById("st").innerHTML = message.errorMessage;
            setTimeout(MQTTconnect, reconnectTimeout);
        }


        function onMessageArrived(msg) {
            if (msg.payloadString == lastsendmsg) {
                var putstr = "admin>>"
                document.getElementById("rcvmsg").innerHTML += putstr.concat(msg.payloadString).concat("Me  <br>");
            } else {
                document.getElementById("rcvmsg").innerHTML += msg.payloadString.concat("<br>");
            }

        }


        function onConnect() {
            // Once a connection has been made, make a subscription and send a message.
            document.getElementById("st").innerHTML = "CONNECTION SUCCESS";
            console.log("Connected ");
            mqtt.subscribe("skarduino");
            message = new Paho.MQTT.Message("Hello World");
            message.destinationName = "skarduino";
            mqtt.send(message);
        }

        function sendMsg() {
            var msgstr = document.getElementById("sendmsg").value;
            message = new Paho.MQTT.Message(msgstr);
            message.destinationName = "skarduino";
            mqtt.send(message);
            lastsendmsg = msgstr;
            document.getElementById("sendmsg").value = "";
        }

        function onSuccess() {
            console.log("All Right");
        }

        function MQTTconnect() {
            console.log("connecting to " + host + " " + port);
            var x = Math.floor(Math.random() * 10000);
            var cname = "orderform-" + x;
            console.log(cname);
            mqtt = new Paho.MQTT.Client(host, port, cname);

            var options = {
                timeout: 10,
                onSuccess: onConnect,
                onFailure: onFailure,
            };

            mqtt.onMessageArrived = onMessageArrived

            mqtt.connect(options); //connect
        }
    </script>
</head>

<body>
    <h1>MQTT Test Page</h1>
    <h4>Topic: "skarduino"</h4>
    <p id="st">CONNECT STATUS</p>
    <label for="sendmsg"></label>
    <input id="sendmsg" type="text" name="sendmsg">
    <button onclick="sendMsg()">Send Msg</button>
    <p id="rcvmsg">

    </p>

    <script>
        MQTTconnect();
    </script>
</body>

</html>